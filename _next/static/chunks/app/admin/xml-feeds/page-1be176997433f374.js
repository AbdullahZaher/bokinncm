(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[167],{2031:function(e,s,t){Promise.resolve().then(t.bind(t,95871))},95871:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return Y}});var a=t(9268),l=t(86006),c=t(51597),r=t(68569),n=t(89423),i=t(25428),d=t(31211),o=t(42442),x=t(55102),h=t(92865),m=t(57115),u=t(87594),j=t(36975),p=t(6176),f=t(56165),g=t(36092),v=t(70525),N=t(20311),_=t(99154),w=t(31859),b=t(96762),y=t(14316);function S(){let[e,s]=(0,l.useState)([]),[t,n]=(0,l.useState)(!0),[i,d]=(0,l.useState)({roomId:"",status:"",dateFrom:"",dateTo:""}),{toast:o}=(0,w.pm)(),x=async()=>{n(!0);try{let e=_.O.from("xml_access_logs").select("\n          *,\n          rooms (\n            name\n          )\n        ").order("accessed_at",{ascending:!1}).limit(100);i.roomId&&(e=e.eq("room_id",i.roomId)),i.status&&(e=e.eq("response_status",parseInt(i.status))),i.dateFrom&&(e=e.gte("accessed_at",i.dateFrom)),i.dateTo&&(e=e.lte("accessed_at",i.dateTo));let{data:t,error:a}=await e;if(a)throw a;s(t.map(e=>({...e,room_name:e.rooms.name})))}catch(e){o({title:"Error",description:"Failed to fetch access logs",variant:"destructive"})}finally{n(!1)}};(0,l.useEffect)(()=>{x()},[i]);let h=e=>e>=200&&e<300?"text-green-600":e>=400&&e<500?"text-yellow-600":"text-red-600";return(0,a.jsxs)(c.Zb,{children:[(0,a.jsx)(c.Ol,{children:(0,a.jsx)(c.ll,{children:"XML Access Logs"})}),(0,a.jsxs)(c.aY,{children:[(0,a.jsxs)("div",{className:"flex gap-4 mb-6",children:[(0,a.jsxs)(N.Ph,{value:i.roomId,onValueChange:e=>d(s=>({...s,roomId:e})),children:[(0,a.jsx)(N.i4,{className:"w-[200px]",children:(0,a.jsx)(N.ki,{placeholder:"Filter by Room"})}),(0,a.jsx)(N.Bw,{children:(0,a.jsx)(N.Ql,{value:"all",children:"All Rooms"})})]}),(0,a.jsxs)(N.Ph,{value:i.status,onValueChange:e=>d(s=>({...s,status:e})),children:[(0,a.jsx)(N.i4,{className:"w-[200px]",children:(0,a.jsx)(N.ki,{placeholder:"Filter by Status"})}),(0,a.jsxs)(N.Bw,{children:[(0,a.jsx)(N.Ql,{value:"all",children:"All Status"}),(0,a.jsx)(N.Ql,{value:"200",children:"Success (200)"}),(0,a.jsx)(N.Ql,{value:"401",children:"Unauthorized (401)"}),(0,a.jsx)(N.Ql,{value:"429",children:"Rate Limited (429)"}),(0,a.jsx)(N.Ql,{value:"500",children:"Error (500)"})]})]}),(0,a.jsx)(v.I,{type:"date",value:i.dateFrom,onChange:e=>d(s=>({...s,dateFrom:e.target.value})),className:"w-[200px]"}),(0,a.jsx)(v.I,{type:"date",value:i.dateTo,onChange:e=>d(s=>({...s,dateTo:e.target.value})),className:"w-[200px]"}),(0,a.jsx)(r.z,{variant:"outline",onClick:()=>d({roomId:"all",status:"all",dateFrom:"",dateTo:""}),children:"Clear Filters"})]}),(0,a.jsxs)(b.iA,{children:[(0,a.jsx)(b.xD,{children:(0,a.jsxs)(b.SC,{children:[(0,a.jsx)(b.ss,{children:"Room"}),(0,a.jsx)(b.ss,{children:"Timestamp"}),(0,a.jsx)(b.ss,{children:"IP Address"}),(0,a.jsx)(b.ss,{children:"User Agent"}),(0,a.jsx)(b.ss,{children:"Status"})]})}),(0,a.jsx)(b.RM,{children:e.map(e=>(0,a.jsxs)(b.SC,{children:[(0,a.jsx)(b.pj,{children:e.room_name}),(0,a.jsx)(b.pj,{children:new Date(e.accessed_at).toLocaleString()}),(0,a.jsx)(b.pj,{children:e.ip_address}),(0,a.jsx)(b.pj,{className:"max-w-xs truncate",title:e.user_agent,children:e.user_agent}),(0,a.jsx)(b.pj,{className:h(e.response_status),children:e.response_status})]},e.id))})]})]})]})}var k=t(25414),C=t(28880),A=t(10273),F=t(31482),Z=t(81037),I=t(78714),O=t(36584),L=t(55257),R=t(10583),D=t(37215),E=t(23),T=t(24088);let U=["#0088FE","#00C49F","#FFBB28","#FF8042"];function B(){let[e,s]=(0,l.useState)(null),[t,r]=(0,l.useState)("7d"),[n,i]=(0,l.useState)(!0),{toast:d}=(0,w.pm)(),o=async()=>{i(!0);try{let e=new Date,a=parseInt(t),l=new Date(e.setDate(e.getDate()-a)),{data:c,error:r}=await _.O.from("xml_access_logs").select("*").gte("accessed_at",l.toISOString());if(r)throw r;let n=new Set(c.map(e=>e.ip_address)).size,i=c.filter(e=>200===e.response_status).length,d=i/c.length*100,o=c.reduce((e,s)=>{let t=s.accessed_at.split("T")[0],a=e.find(e=>e.date===t);return a?a.count++:e.push({date:t,count:1}),e},[]),x=c.reduce((e,s)=>{let t=e.find(e=>e.status===s.response_status);return t?t.count++:e.push({status:s.response_status,count:1}),e},[]),{data:h,error:m}=await _.O.from("rooms").select("id, name, xml_access_count").order("xml_access_count",{ascending:!1}).limit(5);if(m)throw m;s({totalAccess:c.length,uniqueIPs:n,successRate:d,dailyStats:o,statusDistribution:x,topRooms:h.map(e=>({roomName:e.name,accessCount:e.xml_access_count||0}))})}catch(e){d({title:"Error",description:"Failed to fetch analytics data",variant:"destructive"})}finally{i(!1)}};return((0,l.useEffect)(()=>{o()},[t]),n||!e)?(0,a.jsx)("div",{children:"Loading analytics..."}):(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,a.jsxs)(c.Zb,{children:[(0,a.jsx)(c.Ol,{children:(0,a.jsx)(c.ll,{children:"Total Requests"})}),(0,a.jsx)(c.aY,{children:(0,a.jsx)("div",{className:"text-3xl font-bold",children:e.totalAccess})})]}),(0,a.jsxs)(c.Zb,{children:[(0,a.jsx)(c.Ol,{children:(0,a.jsx)(c.ll,{children:"Unique IPs"})}),(0,a.jsx)(c.aY,{children:(0,a.jsx)("div",{className:"text-3xl font-bold",children:e.uniqueIPs})})]}),(0,a.jsxs)(c.Zb,{children:[(0,a.jsx)(c.Ol,{children:(0,a.jsx)(c.ll,{children:"Success Rate"})}),(0,a.jsx)(c.aY,{children:(0,a.jsxs)("div",{className:"text-3xl font-bold",children:[e.successRate.toFixed(1),"%"]})})]})]}),(0,a.jsxs)(c.Zb,{children:[(0,a.jsx)(c.Ol,{children:(0,a.jsx)(c.ll,{children:"Daily Access Trends"})}),(0,a.jsx)(c.aY,{className:"h-[300px]",children:(0,a.jsx)(k.h,{width:"100%",height:"100%",children:(0,a.jsxs)(C.w,{data:e.dailyStats,children:[(0,a.jsx)(A.q,{strokeDasharray:"3 3"}),(0,a.jsx)(F.K,{dataKey:"date"}),(0,a.jsx)(Z.B,{}),(0,a.jsx)(I.u,{}),(0,a.jsx)(O.x,{type:"monotone",dataKey:"count",stroke:"#8884d8"})]})})})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,a.jsxs)(c.Zb,{children:[(0,a.jsx)(c.Ol,{children:(0,a.jsx)(c.ll,{children:"Status Distribution"})}),(0,a.jsx)(c.aY,{className:"h-[300px]",children:(0,a.jsx)(k.h,{width:"100%",height:"100%",children:(0,a.jsxs)(L.u,{children:[(0,a.jsx)(R.b,{data:e.statusDistribution,dataKey:"count",nameKey:"status",cx:"50%",cy:"50%",outerRadius:80,label:!0,children:e.statusDistribution.map((e,s)=>(0,a.jsx)(D.b,{fill:U[s%U.length]},"cell-".concat(s)))}),(0,a.jsx)(I.u,{})]})})})]}),(0,a.jsxs)(c.Zb,{children:[(0,a.jsx)(c.Ol,{children:(0,a.jsx)(c.ll,{children:"Top Rooms by Access"})}),(0,a.jsx)(c.aY,{className:"h-[300px]",children:(0,a.jsx)(k.h,{width:"100%",height:"100%",children:(0,a.jsxs)(E.v,{data:e.topRooms,children:[(0,a.jsx)(A.q,{strokeDasharray:"3 3"}),(0,a.jsx)(F.K,{dataKey:"roomName"}),(0,a.jsx)(Z.B,{}),(0,a.jsx)(I.u,{}),(0,a.jsx)(T.$,{dataKey:"accessCount",fill:"#8884d8"})]})})})]})]})]})}function Y(){let[e,s]=(0,l.useState)([]),[t,k]=(0,l.useState)([]),[C,A]=(0,l.useState)(!0),[F,Z]=(0,l.useState)(!1),[I,O]=(0,l.useState)(""),[L,R]=(0,l.useState)("all"),{toast:D}=(0,w.pm)(),E=async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{Z(!0);let{data:t,error:a}=await _.O.from("rooms").select("\n          id,\n          name,\n          xml_token,\n          calendar_url,\n          bookingdotcom_xml_url,\n          distribution_link,\n          xml_last_accessed,\n          xml_access_count\n        ").order("name");if(a)throw a;let l=t.map(e=>({roomId:e.id,roomName:e.name,lastAccessed:e.xml_last_accessed,accessCount:e.xml_access_count||0,token:e.xml_token||"",status:e.calendar_url||e.bookingdotcom_xml_url?"active":"inactive",distributionLink:e.distribution_link,hasBookingUrl:!!e.bookingdotcom_xml_url,hasCalendarUrl:!!e.calendar_url}));s(l),e&&D({title:"Updated",description:"Feed list has been refreshed"})}catch(e){console.error("Error:",e),D({title:"Error",description:"Failed to fetch feeds",variant:"destructive"})}finally{A(!1),Z(!1)}};(0,l.useEffect)(()=>{E();let e=setInterval(()=>E(),3e4);return()=>clearInterval(e)},[]),(0,l.useEffect)(()=>{let s=e.filter(e=>{let s=e.roomName.toLowerCase().includes(I.toLowerCase()),t="all"===L||e.status===L;return s&&t});k(s)},[e,I,L]);let T=async e=>{try{let s=Array.from(crypto.getRandomValues(new Uint8Array(25))).map(e=>e.toString(16).padStart(2,"0")).join(""),{error:t}=await _.O.from("rooms").update({xml_token:s,xml_access_count:0,xml_last_accessed:null}).eq("id",e);if(t)throw t;D({title:"Success",description:"XML token regenerated successfully"}),E()}catch(e){D({title:"Error",description:"Failed to regenerate token",variant:"destructive"})}},U=e=>{navigator.clipboard.writeText(e),D({title:"Copied",description:"Distribution link copied to clipboard"})};return C?(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)(y.O,{className:"h-8 w-[200px]"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,a.jsx)(y.O,{className:"h-[100px]"}),(0,a.jsx)(y.O,{className:"h-[100px]"}),(0,a.jsx)(y.O,{className:"h-[100px]"})]}),(0,a.jsx)(y.O,{className:"h-[400px]"})]}):(0,a.jsx)("div",{className:"space-y-6",children:(0,a.jsxs)(i.mQ,{defaultValue:"feeds",className:"space-y-6",children:[(0,a.jsxs)(i.dr,{className:"bg-muted/50 dark:bg-muted/80",children:[(0,a.jsxs)(i.SP,{value:"feeds",className:"flex items-center gap-2",children:[(0,a.jsx)(d.Z,{className:"h-4 w-4"}),"Feeds"]}),(0,a.jsxs)(i.SP,{value:"logs",className:"flex items-center gap-2",children:[(0,a.jsx)(h.Z,{className:"h-4 w-4"}),"Access Logs"]}),(0,a.jsxs)(i.SP,{value:"analytics",className:"flex items-center gap-2",children:[(0,a.jsx)(m.Z,{className:"h-4 w-4"}),"Analytics"]})]}),(0,a.jsx)(i.nU,{value:"feeds",children:(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(()=>(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[(0,a.jsx)(c.Zb,{children:(0,a.jsx)(c.aY,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Rooms"}),(0,a.jsx)("p",{className:"text-2xl font-bold",children:e.length})]}),(0,a.jsx)(d.Z,{className:"h-8 w-8 text-muted-foreground"})]})})}),(0,a.jsx)(c.Zb,{children:(0,a.jsx)(c.aY,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-muted-foreground",children:"Active Feeds"}),(0,a.jsx)("p",{className:"text-2xl font-bold",children:e.filter(e=>"active"===e.status).length})]}),(0,a.jsx)(o.Z,{className:"h-8 w-8 text-muted-foreground"})]})})}),(0,a.jsx)(c.Zb,{children:(0,a.jsx)(c.aY,{className:"pt-6",children:(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-medium text-muted-foreground",children:"Total Access"}),(0,a.jsx)("p",{className:"text-2xl font-bold",children:e.reduce((e,s)=>e+s.accessCount,0)})]}),(0,a.jsx)(x.Z,{className:"h-8 w-8 text-muted-foreground"})]})})})]}),{}),(0,a.jsxs)(c.Zb,{children:[(0,a.jsx)(c.Ol,{children:(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsxs)("div",{className:"relative flex-1",children:[(0,a.jsx)(u.Z,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),(0,a.jsx)(v.I,{placeholder:"Search rooms...",value:I,onChange:e=>O(e.target.value),className:"pl-8"})]}),(0,a.jsxs)(N.Ph,{value:L,onValueChange:R,children:[(0,a.jsx)(N.i4,{className:"w-[180px]",children:(0,a.jsx)(N.ki,{placeholder:"Filter by status"})}),(0,a.jsxs)(N.Bw,{children:[(0,a.jsx)(N.Ql,{value:"all",children:"All Status"}),(0,a.jsx)(N.Ql,{value:"active",children:"Active"}),(0,a.jsx)(N.Ql,{value:"inactive",children:"Inactive"})]})]})]})}),(0,a.jsx)(c.aY,{className:"p-0",children:(0,a.jsxs)(b.iA,{children:[(0,a.jsx)(b.xD,{children:(0,a.jsxs)(b.SC,{children:[(0,a.jsx)(b.ss,{className:"w-[200px]",children:"Room"}),(0,a.jsx)(b.ss,{children:"Status"}),(0,a.jsx)(b.ss,{children:"Calendar Sources"}),(0,a.jsx)(b.ss,{children:"Last Accessed"}),(0,a.jsx)(b.ss,{children:"Access Count"}),(0,a.jsx)(b.ss,{children:"Distribution Link"}),(0,a.jsx)(b.ss,{className:"text-right",children:"Actions"})]})}),(0,a.jsxs)(b.RM,{children:[t.map(e=>(0,a.jsxs)(b.SC,{children:[(0,a.jsx)(b.pj,{className:"font-medium",children:e.roomName}),(0,a.jsx)(b.pj,{children:(0,a.jsxs)(n.C,{variant:"active"===e.status?"default":"destructive",className:"flex items-center gap-1 w-fit",children:["active"===e.status?(0,a.jsx)(j.Z,{className:"h-3 w-3"}):(0,a.jsx)(p.Z,{className:"h-3 w-3"}),e.status]})}),(0,a.jsx)(b.pj,{children:(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(n.C,{variant:e.hasCalendarUrl?"default":"secondary",children:"Bokinn"}),(0,a.jsx)(n.C,{variant:e.hasBookingUrl?"default":"secondary",children:"Booking.com"})]})}),(0,a.jsx)(b.pj,{children:e.lastAccessed?new Date(e.lastAccessed).toLocaleString():"Never"}),(0,a.jsx)(b.pj,{children:e.accessCount}),(0,a.jsx)(b.pj,{children:e.distributionLink?(0,a.jsxs)(r.z,{variant:"outline",size:"sm",onClick:()=>U(e.distributionLink),className:"flex items-center gap-2",children:[(0,a.jsx)(f.Z,{className:"h-4 w-4"}),"Copy Link"]}):(0,a.jsx)(n.C,{variant:"outline",children:"No Link"})}),(0,a.jsx)(b.pj,{className:"text-right",children:(0,a.jsxs)(r.z,{variant:"outline",size:"sm",onClick:()=>T(e.roomId),className:"flex items-center gap-2",children:[(0,a.jsx)(g.Z,{className:"h-4 w-4"}),"Regenerate"]})})]},e.roomId)),0===t.length&&(0,a.jsx)(b.SC,{children:(0,a.jsx)(b.pj,{colSpan:7,className:"text-center text-muted-foreground",children:"No feeds found"})})]})]})})]})]})}),(0,a.jsx)(i.nU,{value:"logs",children:(0,a.jsx)(S,{})}),(0,a.jsx)(i.nU,{value:"analytics",children:(0,a.jsx)(B,{})})]})})}}},function(e){e.O(0,[222,795,639,946,69,77,510,182,79,667,488,744],function(){return e(e.s=2031)}),_N_E=e.O()}]);